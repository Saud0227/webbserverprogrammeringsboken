:imagesdir: chapters/databases/images


= Databaser

En databas är en välorganiserad, det vill säga uppbyggd enligt nedskrivna regler, centraliserad, samling av data.

.**Data** vs **information**.
[NOTE]
==== 
Information är behandlad data - det vill säga data som någon kan använda för att tillföra något slags värde i någon slags process eller sammanhang.

Man kan säga att data blir information när någon tittar på eller behandlar den.
====

[discrete]
== Typer av databaser

Det finns i dag två huvudsakliga typer av databaser: *Relationsdatabaser* och *dokument/nod-baserade databaser*. Andra ord som används för att skilja på dessa två typer av databaser är *SQL* (relationella) och *NoSQL* (dokument/nod-baserade).

I den här kursen kommer vi enbart använda oss av SQL-baserade databaser, det vill säga *Relationsdatabaser*.

== Grundläggande terminologi

=== Databashanterare

En Databashanterare/Databashanteringssystem, eller DBMS (Database Management System), är mjukvara som gör det möjligt att på ett effektivt och säkert sätt *definera*, *hämta* och *modifiera* innehåll i en databas.

Man kan inte kommunicera direkt med en databas; all kommunikation sker via en databashanterare.

I den här kursen kommer vi använda oss av *SQLite* som DBMS.

=== Tabeller, rader och kolumner

En relationsdatabas består av en eller flera *tabeller* Varje tabell har ett namn, och består av *rader* och *kolumner*.

.Exempel på en tabell för att hålla koll på böcker
[cols=">1,<3,>1", width="45%"]
|===
3+^| *books*
| *id*  | *title*                   | *page_count*
|  1    | 'Catch 22'                | 464
|  2    | 'To Kill a Mockingbird'   | 336
|  3    | '1984'                    | 328 
|  4    | 'The Stranger'            | 123
|=== 

Tabellen ovan har namnet `books`, och har 4 rader och 3 kolumner.

=== Entiteter och tabeller
En tabell i en databas kallas för en *entitet*

=== Tupler och rader
Varje rad i tabellen kallas för en *tupel* och beskriver en *post* i tabellen. 

I books-tabellen innehåller varje tupel information om en bok.

=== Attribut och kolumner
Varje kolumn beskriver en egenskap, eller *attribut* för posten. 

I books-entiteten är `id`, `title` och `page_count` attribut.

.**Attribut måste vara atomära**
[WARNING]
====
Attribut _måste_ vara *atomära*, det vill säga i varje "cell" eller "fält" får det maximalt finnas _ett_ (1) värde - man får t.ex inte lagra flera titlar i en och samma cell. 

.En *felaktig* tabell med icke-atomära värden i phone_number kolumnen.
[cols=">1,<2,>3", width="70%"]
|===
3+^| *contacts*
| *id*  | *name*             | *phone_number*
|  1    | 'Hermione Granger' | "555-123 45 67", "555-234 56 78"
|  2    | 'Ron Weasly'       | "555-234 56 78"
|=== 

====

== Tabeller och relationer

En relationsdatabas består av tabeller och relationerna mellan tabellerna.

=== Primärnyckel och unika rader

Varje rad i en tabell _måste_ vara unik, det vill säga, i varje tabell får det inte förekomma två rader där samtliga kolumner är identiska.

Detta löses enklast genom att varje tabell har ett _attribut_ som kallas för *primärnyckel* eller *primary key*.

När man skapar tabellen talar man om vilket av attributen som kommer vara primärnyckeln. 

I tabellen ovan har den som skapat tabellen valt attributet `id` som primärnyckel. En primärnyckels värde _måste_ vara unikt för tabellen och kolumnen.

Detta innebär att även om det skulle finnas två böcker som heter _"The Stranger"_, och som båda råkar ha 123 sidor kommer raden fortfarande vara unik, eftersom den kommer få en unikt värde på primärnyckeln.

.Varje tupel är fortfarande unik, trots att det finns två böcker med samma titel och sidantal.
[cols=">1,<3,>1", width="45%"]
|===
3+^| *books*
| *id*  | *title*                   | *page_count*
|  1    | 'Catch 22'                | 464
|  2    | 'To Kill a Mockingbird'   | 336
|  3    | '1984'                    | 328 
|  4    | 'The Stranger'            | 123
|  5    | 'The Stranger'            | 123
|=== 

Databashanterarens (SQLite) kontrollerar att varje primärnyckel/tupel är unik.

.Namngivning av primärnyckeln
[NOTE]
==== 
I den här kursen kommer vi:

- *alltid* använda namnet *id* för primärnyckeln, men primärnyckeln _kan_ heta vad som helst.
- *alltid* använda *automatiskt inkrementerande heltal* för primärnyckeln, men primärnyckeln _kan_ vara vad som helst.
====

=== Relationer

För att knyta samman två tabeller behöver vi skapa en *relation*, det vill säga, en koppling, mellan dem. 

[cols=">1,<3,>1", width="40%"]
|===
3+^| *books*
| *id*  | *title*                   | *page_count*
|  1    | 'Catch 22'                | 464         
|  2    | 'To Kill a Mockingbird'   | 336         
|  3    | '1984'                    | 328         
|  4    | 'The Stranger'            | 123         
|  5    | 'Closing Time'            | 382         
|  6    | 'Animal Farm'             | 218         
|  7    | 'The Plague  '            | 312         
|  8    | 'Coming Up for Air'       | 393         
|===


[cols=">1,<3,<2,<2,>1", width="50%"]
|===
5+^| *authors*
| *id* | *name*            | *nationality* | *birth_year* | *shoe_size*
|  1   | 'Joseph Heller'   | 'American'    | 1923         | 42
|  2   | 'Harper Lee'      | 'American'    | 1926         | 36
|  3   | 'George Orwell'   | 'English'     | 1903         | 41
|  4   | 'Albert Camus'    | 'French'      | 1913         | 44
|===


I exemplet med böcker och författare behöver vi skapa en *en-till-många-relation* mellan authors och books - _en_ författare kan ha skrivit _många_ böcker (men en bok kan bara ha en författare).

=== Främmande nyckel

För att skapa en relation mellan två tabeller använder man en *främmande nyckel*. Man skapar en främmande nyckel genom att kopiera in värdet från  *primärnyckeln* i *en-änden* av relationen i en ny kolumn i *många-änden* av relationen.

I vårt fall innebär det att vi ska lägga till primärnyckeln från **author**-tabellen i **books**-tabellen (en för fattare kan ha skrivit flera böcker).

[cols=">1,<3,>1,<3", width="40%"]
|===
4+^| *books*
| *id*  | *title*                   | *page_count*  | *author_id*
|  1    | 'Catch 22'                | 464           | 1
|  2    | 'To Kill a Mockingbird'   | 336           | 2
|  3    | '1984'                    | 328           | 3
|  4    | 'The Stranger'            | 123           | 4
|  5    | 'Closing Time'            | 382           | 1
|  6    | 'Animal Farm'             | 218           | 3
|  7    | 'The Plague  '            | 312           | 4
|  8    | 'Coming Up for Air'       | 393           | 3
|===

.Namngivning av den främmande nyckeln
[NOTE]
====
Den främmande nyckelns kolumn kan heta precis vad som helst, men i den här boken kommer den främmande nyckelns kolumn-namn **alltid** döpas enligt följande: **namnet på en-ändens tabellnamn _i singular_** följt av ett understreck och sen **id** (**author_id**)
====

== ER-Diagram

För att på ett smidigt sätt kunna _modellera_, det vill säga _designa_ relationsdatabaser finns _Entity Relationship Diagrams_ (ER-diagram).

ER-diagram illustrerar en databas logiska uppbyggnad, det vill säga vilka _entiteter_, _attribut_ och _relationer_ som finns i databasen - det beskriver inte den faktiska datan som lagras i databasen. 

[DISCRETE]
=== Entitet

En entitet (engelska: entity) representerar en en typ av sak som lagras i databasen. Entiteter ritas som rektanglar, med namnet (i singular) i mitten.

.Två entiteter
image::entities.png[Två entiteter i ett ER-diagram]

[DISCRETE]
=== Attribut

Attribut (engelska: attribute) representerar en egenskap på något som lagras i databasen. Attribut ritas som en ovaler, med namnet i mitten. Alla attribut måste tillhöra en tabell, och man drar ett streck mellan entiteten och attributet för att visa vilken entitet ett attribut tillhör.

Om ett attribut på en entitet är unikt för den entiteten, det vill säga, det får i systemet som databasen modellerar inte finnas två saker som har samma värde på det attributet stryker man under det attributet.

.Två entiteter med attribut
image::entities_with_attributes.png[Två entiteter med attribut i ett ER-diagram]

`Primärnycklarna` är alltid understrukna.

[WARNING]
==== 
*Främmande nycklar*

Främmande nycklar ska aldrig ritas ut i ER-diagrammet, deras placering framgår av relationerna (se nästa rubrik)
====

[DISCRETE]
=== Sambandstyp/Relation

Sambandstyper (engelska: relation) visar på kopplingar mellan två entiteter. Sambandstyper ritas som romber. I mitten av romben står ett ett eller flera ord som beskriver entiteternas samband (oftast från ena entitetens perspektiv).

Varje sambandstyp är kopplad med streck till de ingående entiteterna.

[DISCRETE]
=== Kardinalitetsförhållanden

I varje ände av en sambandstyp framgår dess _kardinalitet_ (engelska: cardinality), som mer exakt beskriver vad entiteterna har för _kardinalitetsförhållanden_ eller samband.
Det finns tre typer av kardinalitetsförhållanden:


==== Ett-till-ett-samband (eller 1:1-samband)

Ett 1:1-samband innebär att de ingående entiteterna kan höra ihop med _ett_ exempel av entiteten i andra änden av sambandet.

==== Ett-till-många-samband (eller 1:*-samband)

Ett 1:*-samband innebär att de ingående entiteterna kan höra ihop med _ett_ exempel av entiteten i andra änden av sambandet.

En sambandstyp där entiteten i den ena änden av sambandet kan höra ihop med flera exempel av entiten i den andra änden, men varje exempel i den andra änden hör bara ihop med ett exempel av den första entiteten.

==== Många-till-många-samband (eller \*:*-samband)

Ett \*:*-samband innebär att ett exempel av var och en av de ingående entiteterna kan höra ihop med flera exempel av de övriga ingående entiteterna.

.Två entiteter med attribut och sambandstyp
image::entities_with_attributes_and_relations.png[Två entiteter med attribut och sambandstyp i ett ER-diagram]

I exemplet ovan kan man utläsa att *en* författare kan skriva *många* (men minst 1) böcker,
men en bok kan bara ha en författare. Det är med andra ord en en-till-många-samband.

Sambandstypen är i exemplet ovan är namngiven från författarens perspektiv ("wrote"), men skulle lika gärna kunna vara skriven från en boks perspektiv (t.ex "written by" eller "belongs to".

== Databasmodellering med ER-diagram

I det här kapitlet ska vi med hjälp av ER-diagram och ett par frågor modellera en virtuell bokhylleapplikation.

Den virtuella bokhyllan ska ska hålla koll på en användares alla titlar.

* En titel kan tillhöra flera olika genres (t.ex. "Fantasy" och "Science Fiction").
* En titel har ett namn, ett sidantal, och är skriven av en författare.
* En författare kan ha skrivit flera titlar.
* En genre kan innehålla flera titlar.
* Användaren ska kunna
** Se alla titlar i sin bokhylla, 
** Skriva anteckningar om en titel, 
** Söka bland titlar i sin bokhylla
** Se sina anteckningar om en specifik titel.

[DISCRETE]
=== Identifiera substantiv

Ett trick man kan använda för att identifiera sina entiteter är att leta efter substantiv i beskrivningen av sin problemdomän.

Beskrivningen ovan innehåller följande substantiv: "bokhylla" "användare", "titel", "genre", "namn", "sidantal", "författare", "anteckning".

Vissa substantiv kommer bli våra entiteter, andra kommer att bli attribut våra entiteter har, och vissa kan vi ignorera.

I vårt fall kan vi ignorera substantivet "bokhylla", eftersom hela applikationen är "bokhyllan". I vårt fall kanske hela applikationen skulle kunna heta t.ex "Bookshelf"

[DISCRETE]
=== Frågor för att skilja entiteter från attribut

Första steget är att räkna ut vilka av ens substantiv som blir entiteter (och, i förlängningen, tabeller i databasen), och vilka som blir attribut på entiteterna.

Frågor man kan ställa för att klura ut vilka substantiv som bör bli egna entiteter är:

. Har substantivet flera saker som skulle kunna vara attribut på det?
. Har substantivet verb kopplade till sig (utöver skapa/ta bort/uppdatera)?
. Om substantivet är ett attribut på en (eller flera) annan entitet, skulle det i så fall förekomma på flera rader i den entitetens tabell?
. Om substantivet är ett attribut på en (eller flera) annan entitet, skulle varje rad i den entitetens tabell kunna ha flera av substantivet?

Om svaret är "Ja" på en eller flera av dessa frågor är det troligt att det ska bli en entitet.

Vi går igenom Bokylleapplikationens substantiv och ställer frågorna till dem.

==== Användare

===== Har användare flera saker som skulle kunna vara attribut?

Ja, användare har (antagligen) email, användarnamn, lösenord och information om när hen senast var inloggad.

===== Har användare verb kopplade till sig?

Ja, användare kan logga in/ut, och skriva anteckningar. En användare kan antagligen också lägga till/ta bort böcker.

===== Om användare var attribut på en annan entitet, skulle de i så fall förekomma flera  i den entitetens tabell?

Ja, om användare var attribut på t.ex titel-entiteten skulle de förekomma flera gånger i titel-tabellen, eftersom en användare kan äga flera titlar.

.Title-tabell där samma användardata dupliceras på olika rader
[width="80%" cols="1,2,1,2,2,2",options="header"]
|========
| id | name | isbn | user_name| user_pwd | user_last_login 
| 1  | "Grillboken" | 123 | "Grill" | pwd1 | 2017-08-01
| 2  | "BBQ Book"   | 234 | "Grill" | pwd1 | 2017-08-01
| 3  | "Würstbuch"  | 345 | "Korv"  | pwd2 | 2017-09-23
| 4  | "Kokboken"   | 456 | "Korv"   | pwd2 | 2017-09-23
|========

Title-tabellen innehåller duplicerad data om användaren (rad 1 & 2 och rad 3 & 4), vilket vi vill undvika.

===== Om användare var attribut på en annan entitet, skulle det i så fall kunna finnas flera användare på varje rad i den entitetens tabell?

Ja, om användare var attribut på t.ex. en titel skulle varje titel kunna ha flera användare, eftersom flera användare kan äga samma titel.

.Title-tabell där varje rad innehåller data om flera användare
[width="80%" cols="1,2,1,6,3,10",options="header"]
|========
| id | name | isbn | user_names| user_pwds | user_last_logins 
| 1  | "Grillboken" | 123 | "Grill", "Korv", ... | ..., ..., ... | 2017-08-01, 2017-09-23, ... 
|========

En cell i en tabell får endast innehålla ett värde, så det här fungerar inte.

===== Slutsats Användare:

Samtliga frågor har besvarats med "Ja". Användare bör därmed vara en egen entitet.

==== Titel

===== Har titlar flera saker som skulle kunna vara attribut?

Ja, en titel har namn, isbn, författare, utgivningsår, genres, sidantal, anteckningar

===== Har titlar verb kopplade till sig?

Nej, inte utöver skapa/ta bort/uppdatera

===== Om en titel var attribut på en annan entitet, skulle de i så fall förekomma på flera rader i den entitetens tabell?

Ja, om titlar var attribut på användare så skulle varje titel förekomma på flera rader, eftersom flera användare kan ha samma titel:

.User-tabell där samma titel-data dupliceras på olika rader
[width="80%" cols="1,2,1,6,3,10",options="header"]
|========
| id | username | pwd | title_name  | title_isbn |title_pagecount  
| 1  | "Grill" | pwd1 | "Grillboken" | 123 | 1337
| 2  | "Korv"  | pwd2 | "Grillboken" | 123 | 1337
| 3  | "Senap" | pwd3 | "BBQ Book"   | 234 | 42
| 4  | "Ketchup| pwd4 | "Grillboken" | 123 | 1337
|========

Grillbokens information är dublicerad i tabellen, vilket vi vill undvika.

Om titlar var attribut på författare skulle det kunna fungera (men se fråga 4 nedan):

.Author-tabell med titel som attribut (ingen duplicering)
[width="80%" cols="1,3,3,3,1,1",options="header"]
|========
| id | name | country | title_name  | title_isbn |title_pagecount  
| 1  | "F. Örfattare"      | "Sweden" | "Grillboken" | 123 | 1337
| 2  | "A. Uthor" | "Great Britain"    | "BBQ Book" | 234 | 42
| 3  | "V. Erfasserin" | "Germany" | "Würstbuch"   | 345 | 7331
|========

===== Om en titel var ett attribut på en annan entitet, skulle de i så fall kunna förekomma flera gånger på en rad?

Ja, om en titel var ett attribut på författare eller användare skulle varje författares eller användares rad behöva ha flera titlar.

.Author-tabell där varje rad innehåller data om flera titlar
[width="80%" cols="1,3,3,3,1,1",options="header"]
|========
| id | name | country | title_names  | title_isbns |title_pagecounts  
| 1  | "F. Örfattare"      | "Sweden" | "Grillboken", "Kokboken", ... | 123, 456, ... | 1337, 21, ...
| 2  | "A. Uthor" | "Great Britain"    | "BBQ Book" , "Cookbook", ....| 234, 567, ... | 42, 512, ...
|========

.User-tabell där varje rad innehåller data om flera titlar.
[width="80%" cols="1,1,1,5,2,1",options="header"]
|========
| id | username | pwd | title_names  | title_isbns |title_pagecounts  
| 1  | "Grill"     | pwd1 | "Grillboken", "Kokboken", ... | 123, 456, ... | 1337, 21, ...
| 2  | "Korv" | pwd2    | "BBQ Book" , "Cookbook", ...| 234, 567, ... | 42, 512, ...
|========

Båda tabellerna ovan innehåller celler med mer än ett värde, vilket inte är tillåtet.

===== Slutsats

Flera av frågorna har besvarats med "Ja". Titel bör vara en egen entitet

==== Genre

===== Har genres flera saker som skulle kunna vara attribut?

Nja, en genre har antagligen bara ett attribut: namn.

===== Har genres verb kopplade till sig?

Nej, inte utöver skapa/ta bort/upddatera.

===== Om en genre var attribut på en annan entitet, skulle de i så fall förekomma på flera rader i den entitetens tabell?

Ja, om genres var entiteter på t.ex. titlar skulle varje genre förekomma flera gånger i tabellen, eftersom en genre kan ha många titlar

.Title-tabell där samma genre-data dupliceras på olika rader
[width="80%" cols="1,2,1,1,1",options="header"]
|========
| id | name | isbn | pagecount| genre  
| 1  | "Grillboken" | 123 | 1337 | "Grillning"  
| 2  | "BBQ Book"   | 234 | 42 | "Grillning"  
| 3  | "Würstbuch"  | 345 | 7331 | "Korv"   
|========

I tabellen ovan dupliceras datan om genre, men eftersom det enbart är ett enstaka fält, skulle det kunna vara OK.

===== Om en genre var attribut på en annan entitet, skulle de i så fall förekomma flera gånger på samma rad?

Ja, om genre var ett attribut på en titel skulle genren förekomma flera gånger på varje titels rad, eftersom varje titel kan ha flera genres

.Titel-tabell där varje rad innehåller information om flera genres
[width="80%" cols="1,2,1,1,2",options="header"]
|========
| id | name | isbn | pagecount| genres  
| 1  | "Grillboken" | 123 | 1337 | "Matlagning", "Grillning"  
| 2  | "BBQ Book"   | 234 | 42 | "Matlagning", "Grillning"  
| 3  | "Würstbuch"  | 345 | 7331 | "Matlagning", "Korv"   
|========

En cell i en tabell får endast innehålla ett värde, så det här fungerar inte.

===== Slutsats:

Flera av frågorna har besvarats med "Ja". Genre bör vara en egen entitet

==== Namn

===== Har namn flera saker som skulle kunna vara attribut?

Nej (eventuellt skulle en titel kunna ha olika namn på olika språk).

===== Har namn verb kopplade till sig?

Nej, inte utöver skapa/ta bort/uppdatera

===== Om namn var attribut på en annan entitet, skulle de i så fall förekomma på flera rader i den entitetens tabell?

Nej (teoretiskt sett kan det finnas titlar med samma namn, men det är väldigt ovanligt).

===== Om namn var attribut på en annan entitet, skulle de i så fall förekomma flera gånger på samma rad?

Nej. En titel har bara ett namn (återigen: eventuellt kan namnet kan finnas på flera språk).

===== Slutsats:

Samtliga fyra frågor besvarades med "Nej". Namn bör vara ett attribut (på titel).

==== Sidantal

===== Har sidantal flera saker som skulle kunna vara attribut?

Nej.

===== Har sidantal verb kopplade till sig?

Nej, inte utöver skapa/ta bort/uppdatera.

===== Om sidantal var attribut på en annan entitet, skulle de i så fall förekomma på flera rader i den entitetens tabell?

Nja, det finns antagligen flera böcker som har samma sidantal. Men det skulle inte innebära någon vidare duplikation av data.

===== Om sidantal var attribut på en annan entitet, skulle de i så fall förekomma flera gånger på samma rad?

Nej. En titel har bara ett sidantal (olika utgåvor av en bok kanske har olika sidantal dock).

===== Slutsats:

Ingen av frågorna besvarades med "Ja". Sidantal bör vara ett attribut (på titel).

==== Författare

===== Har författare flera saker som skulle kunna vara attribut?

Ja, förnamn, efternamn, nationalitet, födelseår.

===== Har författare verb kopplade till sig?

Nej, inte utöver skapa/ta bort/uppdatera.

===== Om författare var attribut på en annan entitet, skulle de i så fall förekomma på flera rader i den entitetens tabell?

Ja, om författare var ett attribut på en titel skulle författaren förekomma på flera rader i titeltabellen eftersom författaren kan skriva flera böcker.

.Title-tabell där samma författar-data dupliceras på flera rader
[width="80%" cols="1,2,1,1,2,2",options="header"]
|========
| id | name | isbn | pagecount| author_name | author_country   
| 1  | "Grillboken" | 123 | 1337 | "F. Örfattare" | "Sweden"
| 2  | "BBQ Book"   | 234 | 42 |   "A. Uthor" | "Great Britain"
| 3  | "Würstbuch"  | 345 | 7331 | "V. Erfatterin" | "Germany""
| 4  | "Kokboken"   | 456 | 512  | "F. Örfattare" | "Sweden"
|========

I tabellen ovan dupliceras datan om varje författare, vilket vi vill undvika.

===== Om författare var attribut på en annan entitet, skulle de i så fall förekomma flera gånger på samma rad?

Nja. Författare skulle kunnna vara ett attribut på en titel, eftersom en titel bara har en författare (i vår applikation, men det kan vara önskvärt att bygga ut funktionalitet för att tillåta flera författare på en bok - det är inte ovanligt att författare samarbetar).

.Title-tabell där samma författar-data dupliceras på olika rader
[width="80%" cols="1,2,1,1,2,2",options="header"]
|========
| id | name | isbn | pagecount| author_name | author_country   
| 1  | "Grillboken" | 123 | 1337 | "F. Örfattare" | "Sweden"
| 2  | "BBQ Book"   | 234 | 42 |   "A. Uthor" | "Great Britain"
| 3  | "Würstbuch"  | 345 | 7331 | "V. Erfatterin" | "Germany""
|========

I tabellen ovan finns det bara en författare per rad, vilket skulle kunna vara OK (men se fråga 3).

===== Slutsats:

Flera av frågorna har besvarats med "Ja". Författare bör vara en entitet

==== Anteckning

===== Har anteckningar flera saker som skulle kunna vara attribut?

Ja, en användare. Och kanske en titel, och datum den är skapad?

===== Har anteckningar verb kopplade till sig?

Nej, inte utöver skapa/ta bort/uppdatera.

===== Om anteckning var attribut på en annan entitet, skulle de i så fall förekomma på flera rader i den entitetens tabell?

Nej, om anteckning var ett attribut på användare eller titel skulle antagligen varje anteckning fortfarande vara unik (eventuella dubletter skulle vara ett sammanträffande).

.Title-tabell med anteckning som attribut
[width="80%" cols="1,2,1,1,8,1", options="header"]
|========
| id | name | isbn | pagecount| user_note | user_id 
| 1  | "Grillboken" | 123 | 1337 | "This book smells funny" | 1
| 2  | "BBQ Book"   | 234 | 42 |   "This book has a weird taste" | 2
| 3  | "Würstbuch"  | 345 | 7331 | "I like turtles!" | 1
|========

I tabellen ovan dupliceras ingen data, men se fråga 4.

===== Om anteckning var attribut på en annan entitet, skulle de i så fall förekomma flera gånger på samma rad?

Ja. En om anteckning är ett attribut på användare eller titel skulle varje rad i användar- eller titel-tabellen behöva innehålla flera anteckningar, eftersom både titlar och användare kan ha flera anteckningar.

.Title-tabell där varje rad innehåller data om flera anteckningar
[width="80%" cols="1,2,1,1,10,1", options="header"]
|========
| id | name | isbn | pagecount| user_notes | user_ids
| 1  | "Grillboken" | 123 | 1337 | "This book smells funny", "To Grill or not to Grill", ... |1, 2, ...
| 2  | "BBQ Book"   | 234 | 42 |   "This book has a weird taste", "BBQ is Life!", ... | 2, 3, ...
|========

Tabellen ovan innehåller flera anteckningar per cell, vilket inte är tillåtet.

===== Slutsats:

Flera av frågorna har besvarats med "Ja". Anteckning bör vara en entitet.

=== Entiteter med exempelattribut

Baserat på slutsatserna kan vi skapa en skiss över våra entiteter med exempelattribut:

.Exempelentiteter med attribut
image::entities2.png[Exempelentiteter med attribut]

////
[graphviz, ./img/entities, svg, layout="fdp"]
----
graph ER {

        node [shape=box]; Title;
        node [shape=ellipse]; {node [label="id"] idTitle}; {node [label="name"] nameTitle}; isbn; pagecount;
        
        Title -- idTitle;
        Title -- nameTitle;
        Title -- isbn;
        Title -- pagecount;

        node [shape=box]; User;
        node [shape=ellipse]; {node [label="id"] idUser}; username; password;
        
        User -- idUser;
        User -- username;
        User -- password;

        node [shape=box]; Author;
        node [shape=ellipse]; {node [label="id"] idAuthor}; first_name; last_name;
        
        Author -- idAuthor;
        Author -- first_name;
        Author -- last_name;

        node [shape=box]; Note;
        node [shape=ellipse]; {node [label="id"] idNote}; content; created_on;
        
        Note -- idNote;
        Note -- content;
        Note -- created_on;

        node [shape=box]; Genre;
        node [shape=ellipse]; {node [label="id"] idGenre}; {node [label="name"] nameGenre};
        
        Genre -- idGenre;
        Genre -- nameGenre;
}
----
////

[DISCRETE]
=== Associationer & Kardinalitet

Nästa steg är att markera kardinaliteten mellan entiteterna.

==== En-till-många-relationer

En titel kan ha många anteckningar, men varje anteckning tillhör bara en titel.

I ER-diagrammet markeras en en-till-många-relation med hjälp av en etta ( 1 ) i "ett-änden" av relationen, och en asterisk ( * ) i många-änden av relationen:

.En-till-många-relation mellan title och note
image::one-to-many.png[En-till-många-relation mellan title och note]

I databasen kommer relationen skapas genom att det i många-ändens-tabell läggs till en främmande nyckel som innehåller en-ändens-primärnyckel.

.Title-tabellen ("en-änden" i relationen).
[width="50%" cols="1,2,1,1", options="header"]
|========
| id | name | isbn | pagecount
| 1  | "Grillboken" | 123 | 1337 
| 2  | "BBQ Book"   | 234 | 42
| 3  | "Würstbuch"  | 345 | 7331
|========

.Note-tabellen ("många-änden" i relationen).
[width="40%" cols="1,3,1", options="header"]
|========
| id | content | title_id
| 1  | "This book tastes weird" | 1 
| 2  | "This book smells funny" | 1 
| 3  | "I Like turtles!"  | 2
|========

Vissa entiteter, som t.ex anteckning, kommer vara i en-änden av flera relationer: En användare kan ha flera anteckningar, men en anteckning tillhör bara en användare.

.En-till-många-relationer mellan note och title och note och user
image::one-to-many2.png[En-till-många-relationer mellan note och title och note och user]

.User-tabell ("en-änden" av relationen)
[width="30%" cols="1,2,1,options="header"]
|========
| id | username | pwd
| 1  | "Grill"  | pwd1
| 2  | "Korv" 	| pwd2   
| 3  | "Senap"	| pwd3
| 4  | "Ketchup"| pwd4
|========

I databasen kommer notes-tabellen ha både "user_id" och "title_id":

.Note-tabellen ("många-änden" i *två* relationer).
[width="50%" cols="1,3,1,1", options="header"]
|========
| id | content | user_id | title_id
| 1  | "This book tastes weird" | 1 | 1
| 2  | "This book smells funny" | 1 | 2
| 3  | "I Like turtles!"  | 2 | 1
|========

==== Många-till-många-relationer

En titel kan tillhöra många genres, och varje genre kan ha flera titlar.

I ER-diagrammet markeras en många-till-många-relation med hjälp av en asterisker ( * ) i båda-ändarna av relationen:

.Många-till-många-relation mellan genre och titel
image::many-to-many.png[Många-till-många-relation mellan genre och titel]

Många till-många-relationer går inte att skapa i databastabeller, utan kräver en extra tabell; en så kallad _relationstabell_.

En relationstabell är en extra tabell som ligger mellan de två ingående entiteterna och omvandlar relationen till två stycken en-till-många-relationer iställer. 
Om man inte kan komma på vad man ska döpa relationen kan man döpa den till de två ingående entiteternas namn ( i vårt fall "Genre-Titles")

.Title-tabellen (ena "en-änden" i många-till-många-relationen).
[width="50%" cols="1,2,1,1", options="header"]
|========
| id | name | isbn | pagecount
| 1  | "Grillboken" | 123 | 1337 
| 2  | "BBQ Book"   | 234 | 42
| 3  | "Würstbuch"  | 345 | 7331
|========

.Genre-tabellen (andra "en-änden" i många-till-många-relationen).
[width="30%" cols="1,2,options="header"]
|========
| id | name 
| 1  | "Matlagning" 
| 2  | "Grillning"   
| 3  | "Korv"  
|========

.Genre-Title-tabellen (relationstabellen i många-till-många-relationen)
[width="20%" cols="1,1,options="header"]
|========
| title_id | genre_id 
| 1  | 1
| 1  | 2
| 2  | 1
| 2  | 2
| 3  | 3  
|========


[graphviz, ./img/entities2, svg, layout="fdp"]
----
graph ER {
        node [shape=box]; Title;
        node [shape=ellipse]; {node [label="id"] idTitle}; {node [label="name"] nameTitle}; isbn; pagecount;
        
        Title -- idTitle;
        Title -- nameTitle;
        Title -- isbn;
        Title -- pagecount;

        node [shape=box]; User;
        node [shape=ellipse]; {node [label="id"] idUser}; username; password;
        
        User -- idUser;
        User -- username;
        User -- password;

        node [shape=box]; Author;
        node [shape=ellipse]; {node [label="id"] idAuthor}; first_name; last_name;
        
        Author -- idAuthor;
        Author -- first_name;
        Author -- last_name;

        node [shape=box]; Note;
        node [shape=ellipse]; {node [label="id"] idNote}; content; created_on;
        
        Note -- idNote;
        Note -- content;
        Note -- created_on;

        node [shape=box]; Genre;
        node [shape=ellipse]; {node [label="id"] idGenre}; {node [label="name"] nameGenre};
        
        Genre -- idGenre;
        Genre -- nameGenre;

        node [shape=diamond]; Authors; Takes; Has; Contains;
        Author -- Authors [label="1",len=1.00];
        Authors -- Title [label="*", len=1.00];
        User -- Takes [label="1", len=1.00];
        Takes -- Note [label="*", len=1.00];
        Title -- Has [label="1", len=1.00];
        Has -- Note [label="*", len=1.00];
        Genre -- Contains [label="*", len=1.00]
        Contains -- Title [label="*", len=1.00]

}
----
